/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user can only access their own data,
 * specifically their user document and their associated transactions. The rules are designed to prevent
 * unauthorized access and ensure data privacy.
 *
 * Data Structure:
 * Data is nested under /artifacts/{appId}/users/{userId}/transactions/{transactionId}.
 * - The /artifacts/{appId}/users/{userId} path stores user documents.
 * - The /artifacts/{appId}/users/{userId}/transactions/{transactionId} path stores financial transactions
 *   associated with the specific user.
 *
 * Key Security Decisions:
 * - User listing is implicitly disallowed because there are no rules allowing it on the /users collection.
 * - Path-based ownership is enforced for both user documents and transactions. The userId in the path must
 *   match the authenticated user's UID.
 * - The ruleset defaults to a strict security posture, explicitly denying any access not specifically allowed.
 *
 * Denormalization for Authorization:
 * The data model does not require denormalization because authorization is achieved through path-based rules,
 * where the `userId` in the path is matched against the `request.auth.uid`.
 *
 * Structural Segregation:
 * There is no need for structural segregation as all data is private and user-specific.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by the authenticated user with the matching userId.
     * @param {string} userId - The userId from the path.
     * @return {bool} - True if the UID matches the userId, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is signed in.
     * @return {bool} - True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the owner already exists
     * @param {string} userId - The userId from the path.
     * @return {bool} - True if the UID matches the userId, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Security rules for User documents.
     * @path /artifacts/{appId}/users/{userId}
     * @allow (create) User 'efsyBj62qqeFnpAsFi107dQ6n022' can create their own user document.
     * @deny (create) User 'attackerUID' cannot create a user document with userId 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @allow (get) User 'efsyBj62qqeFnpAsFi107dQ6n022' can get their own user document.
     * @deny (get) User 'attackerUID' cannot get the user document of 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @allow (update) User 'efsyBj62qqeFnpAsFi107dQ6n022' can update their own user document.
     * @deny (update) User 'attackerUID' cannot update the user document of 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @allow (delete) User 'efsyBj62qqeFnpAsFi107dQ6n022' can delete their own user document.
     * @deny (delete) User 'attackerUID' cannot delete the user document of 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @principle Enforces document ownership for all operations on user documents.
     */
    match /artifacts/{appId}/users/{userId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
      allow list: if false;
    }

    /**
     * @description Security rules for Transaction documents.
     * @path /artifacts/{appId}/users/{userId}/transactions/{transactionId}
     * @allow (create) User 'efsyBj62qqeFnpAsFi107dQ6n022' can create a transaction under their user ID.
     * @deny (create) User 'attackerUID' cannot create a transaction under user ID 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @allow (get) User 'efsyBj62qqeFnpAsFi107dQ6n022' can get a transaction under their user ID.
     * @deny (get) User 'attackerUID' cannot get a transaction under user ID 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @allow (update) User 'efsyBj62qqeFnpAsFi107dQ6n022' can update a transaction under their user ID.
     * @deny (update) User 'attackerUID' cannot update a transaction under user ID 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @allow (delete) User 'efsyBj62qqeFnpAsFi107dQ6n022' can delete a transaction under their user ID.
     * @deny (delete) User 'attackerUID' cannot delete a transaction under user ID 'efsyBj62qqeFnpAsFi107dQ6n022'.
     * @principle Enforces document ownership for all operations on transaction documents.
     */
    match /artifacts/{appId}/users/{userId}/transactions/{transactionId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }
  }
}